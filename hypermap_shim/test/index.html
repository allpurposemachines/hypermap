<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>HyperMap Shim Tests</title>
	<link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
</head>
<body style="font-family: 'Helvetica Neue', sans-serif">
	<h1>HyperMap Shim Test Output</h1>
	<div id="mocha"></div>

	<script src="https://unpkg.com/chai@4/chai.js"></script>
	<script src="https://unpkg.com/mocha/mocha.js"></script>
	<script src="https://unpkg.com/sinon/pkg/sinon.js"></script>
	<script src="/src/hypermap_shim.js"></script>

	<script class="mocha-init">
		mocha.setup('bdd');
		mocha.checkLeaks();
	</script>

	<script type="module">
		const assert = chai.assert;

		describe("globalThis.parseHypermap", () => {
			it("parses an empty HyperMap", () => {
				const map = parseHypermap("{}");
				assert.equal(map.size, 0);
			});

			it("parses a simple HyperMap", () => {
				const map = parseHypermap('{"a": 1}');
				assert.equal(map.at('a').value, 1);
			});

			it("parses a nested HyperMap", () => {
				const map = parseHypermap('{"a": {"b": 2}}');
				assert.equal(map.at('a').at('b').value, 2);
			});

			it("parses a list", () => {
				const map = parseHypermap('{"a": [1, 2, 3]}');
				assert.equal(map.at('a').size, 3);
				assert.equal(map.at('a').at(0).value, 1);
				assert.equal(map.at('a').at(1).value, 2);
				assert.equal(map.at('a').at(2).value, 3);
			});

			it("parses attributes as properties", () => {
				const map = parseHypermap('{"#": {"href": "https://example.com", "scripts": ["https://example.com/foo.js"]}, "a": 1}');
				assert.equal(map.attributes.href, "https://example.com/");
				assert.equal(map.attributes.scripts[0].href, "https://example.com/foo.js");
			});

			it("doesn't parse invalid attributes", () => {
				assert.throws(() => {
					parseHypermap('{"#": "not an object"}');
				}, /Invalid attribute/);
			});
		});

		describe("the MapNode interface", () => {
			it("can check for key existence", () => {
				const map = parseHypermap('{"a": {}}');

				assert.isTrue(map.has('a'));
				assert.isFalse(map.has('b'));
			});

			it("can set a number value", () => {
				const map = parseHypermap("{}");
				map.set('a', new NumberNode(1));
				assert.equal(map.at('a').value, 1);
			});

			it("can set a nested value", () => {
				const map = parseHypermap('{"a": {}}');
				map.at('a').set('b', new NumberNode(2));
				assert.equal(map.at('a').at('b').value, 2);
			});

			it("can delete a key", () => {
				const map = parseHypermap('{"a": {}}');
				map.delete('a');
				assert.isFalse(map.has('a'));
			})

			it("can set a list", () => {
				const map = parseHypermap("{}");
				map.set('a', new ListNode([new NumberNode(1)]));
				assert.equal(map.at('a').size, 1);
				assert.equal(map.at('a').at(0).value, 1);
			});

			it("can set attributes", () => {
				const map = parseHypermap("{}");
				map.attributes.href = "https://example.com";
				assert.equal(map.attributes.href, "https://example.com");
			});
		});

		describe("simple ListNode mutation", () => {
			it("can append a node", () => {
				const map = parseHypermap('{"a": [1, 2]}');
				map.at('a').append(new NumberNode(3));
				assert.equal(map.at('a').size, 3);
				assert.equal(map.at('a').at(2).value, 3);
			});

			it("can prepend a node", () => {
				const map = parseHypermap('{"a": [2, 3]}');
				map.at('a').prepend(new NumberNode(1));
				assert.equal(map.at('a').size, 3);
				assert.equal(map.at('a').at(0).value, 1);
			});

			it("can insert a node", () => {
				const map = parseHypermap('{"a": [1, 3]}');
				map.at('a').insert(1, new NumberNode(2));
				assert.equal(map.at('a').size, 3);
				assert.equal(map.at('a').at(1).value, 2);
			});

			it("can remove a node", () => {
				const map = parseHypermap('{"a": [1, 2, 3]}');
				map.at('a').remove(1);
				assert.equal(map.at('a').size, 2);
				assert.equal(map.at('a').at(0).value, 1);
				assert.equal(map.at('a').at(1).value, 3);
			});
		});

		describe("simple script execution", () => {
			it("can execute a simple script", async () => {
				const map = parseHypermap('{"#": {"scripts": ["/test/assets/set.js"]}}');
				assert.equal(map.attributes.scripts[0].href, 'http://localhost:3000/test/assets/set.js');

				// Set the tab's hypermap... needed?
				globalThis.hypermap = map;
				await map.start();

				assert.equal(map.at('started').value, true);
				delete globalThis.hypermap;
			});
		});

		describe("mutation events", () => {
			it("raises window events on map set", () => {
				const handler = sinon.fake();
				const map = parseHypermap('{"foo": false}');

				window.addEventListener('mutation', (event) => {
					handler(event);
				});

				map.set('foo', new BooleanNode(true));
				assert.equal(handler.calledOnce, true);
			});

			it("raises window events on list set", () => {
				const handler = sinon.fake();
				const map = parseHypermap('{"foo": [false]}');

				window.addEventListener('mutation', (event) => {
					handler(event);
				});

				map.at('foo').set(0, new BooleanNode(true));
				assert.equal(handler.calledOnce, true);
			});

			it("raises window events on list prepend", () => {
				const handler = sinon.fake();
				const map = parseHypermap('{"foo": [2]}');

				window.addEventListener('mutation', (event) => {
					handler(event);
				});

				map.at('foo').prepend(new NumberNode(1));
				assert.equal(handler.calledOnce, true);
			});

			it("raises window events on list append", () => {
				const handler = sinon.fake();
				const map = parseHypermap('{"foo": [1]}');

				window.addEventListener('mutation', (event) => {
					handler(event);
				});

				map.at('foo').prepend(new NumberNode(2));
				assert.equal(handler.calledOnce, true);
			});

			it("raises window events on list insert", () => {
				const handler = sinon.fake();
				const map = parseHypermap('{"foo": [1, 3]}');

				window.addEventListener('mutation', (event) => {
					handler(event);
				});

				map.at('foo').insert(1, new NumberNode(2));
				assert.equal(handler.calledOnce, true);
			});
		})
	</script>

	<script class="mocha-exec" type="module">
		mocha.run();
	</script>
</body>
</html>
