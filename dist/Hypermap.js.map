{"version":3,"sources":["../src/Hypermap.js"],"sourcesContent":["import { isMap } from './utils/json_processing.js';\nimport Hyperlist from './Hyperlist.js';\n\nexport default class Hypermap extends EventTarget {\n\tattributes;\n\tmap;\n\t#parent;\n\n\tconstructor(data, attributes, parent) {\n\t\tsuper();\n\t\tthis.map = new Map(Object.entries(data));\n\t\tthis.attributes = attributes;\n\t\tthis.#parent = parent;\n\t}\n\n\tstatic fromLiteral(object, parent = null) {\n\t\tconst attributes = object['@'] || {};\n\t\tdelete object['@'];\n\n\t\tlet hypermap = new this(object, attributes, parent);\n\t\thypermap.forEach((value, key) => {\n\t\t\tif (isMap(value)) {\n\t\t\t\thypermap.map.set(key, this.fromLiteral(value, hypermap));\n\t\t\t} else if (Array.isArray(value)) {\n\t\t\t\thypermap.map.set(key, Hyperlist.fromLiteral(value, hypermap));\n\t\t\t}\n\t\t});\n\t\treturn hypermap;\n\t}\n\n\tstatic isCollection(value) {\n\t\treturn ['Hypermap', 'Hyperlist'].includes(value.constructor.name);\n\t}\n\n\tasync hydrate() {\n\t\tif (this.attributes.script) {\n\t\t\ttry {\n\t\t\t\tawait import(this.attributes.script);\n\t\t\t} catch(err) {\n\t\t\t\tconsole.log(`Error importing script at ${this.attributes.script}`, err.message);\n\t\t\t}\n\t\t}\n\t\n\t\tif (this.attributes.rels?.includes('transclude')) {\n\t\t\tthis.fetchTransclusion();\n\t\t}\n\n\t\tthis.children().forEach(child => {\n\t\t\tchild.hydrate();\n\t\t})\n\t}\n\n\t// Todo: make isomorphic\n\tasync fetch() {\n\t\tconst method = this.attributes.method || 'get';\n\t\tconst url = new URL(this.attributes.href, window.location);\n\n\t\tif (method === 'get') {\n\t\t\tif (this.attributes.rels?.includes('transclude')) {\n\t\t\t\tawait this.fetchTransclusion();\n\t\t\t} else {\n\t\t\t\twindow.location.assign(url);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tconst headers = {\n\t\t\t'Content-Type': 'application/json'\n\t\t};\n\n\t\tconst body = {};\n\t\tthis.forEach((value, key) => {\n\t\t\tbody[key] = value;\n\t\t});\n\n\t\tconst options = { method, headers, body: JSON.stringify(body) };\n\t\tconst response = await fetch(url, options);\n\n\t\tif (response.redirected) {\n\t\t\twindow.location.assign(response.url);\n\t\t}\n\t}\n\n\tforEach(callbackfn) {\n\t\tthis.map.forEach(callbackfn);\n\t}\n\n\tat(...path) {\n\t\tif (path.length === 0) {\n\t\t\treturn this;\n\t\t}\n\t\t\n\t\tconst head = this.map.get(path.at(0));\n\t\tif (head === undefined || (path.length > 1 && typeof head.at !== 'function')) {\n\t\t\treturn undefined;\n\t\t}\n\t\t\n\t\tif (path.length === 1) {\n\t\t\treturn head;\n\t\t} else {\n\t\t\treturn head.at(...path.slice(1));\n\t\t}\n\t}\n\n\tparent() {\n\t\tthis.parent;\n\t}\n\n\tchildren() {\n\t\treturn [...this.map]\n\t\t\t.filter(([, value]) => Hypermap.isCollection(value))\n\t\t\t.map(([, value]) => value);\n\t}\n\t\n\tpath() {\n\t\tif (this.#parent === null) {\n\t\t\treturn [];\n\t\t} else {\n\t\t\treturn this.#parent.path().concat(this.#parent.keyFor(this));\n\t\t}\n\t}\n\n\tkeyFor(node) {\n\t\tfor (const [key, value] of this.map) {\n\t\t\tif (value === node) {\n\t\t\t\treturn key;\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\thas(key) {\n\t\treturn this.map.has(key);\n\t}\n\n\tset(key, value) {\n\t\tthis.map.set(key, value);\n\t\tconst event = new CustomEvent('changed', { detail: { key, value } });\n\t\tthis.dispatchEvent(event);\n\t\twindow.contentChanged();\n\t\treturn this;\n\t}\n\n\tkeys() {\n\t\treturn this.map.keys();\n\t}\n\n\treplace(otherHypermap) {\n\t\tthis.map = otherHypermap.map;\n\t\treturn this;\n\t}\n\n\tlength() {\n\t\tthrow new Error('DRAGONS');\n\t}\n\n\tasync fetchTransclusion() {\n\t\tconst response = await fetch(this.attributes.href);\n\t\tconst json = await response.json();\n\t\t// Todo: should handle scripts and sub-transclusions\n\t\tconst newNode = Hypermap.fromLiteral(json);\n\t\tthis.replace(newNode);\n\t}\n\n\ttoJSON() {\n\t\tconst obj = Object.fromEntries(this.map);\n\t\tif (Object.entries(this.attributes).length > 0) {\n\t\t\tobj['@'] = this.attributes;\n\t\t}\n\t\treturn obj;\n\t}\n\n\ttoString() {\n\t\treturn JSON.stringify(this, null, 2);\n\t}\n}\n"],"names":["Hypermap","EventTarget","attributes","map","parent","constructor","data","Map","Object","entries","fromLiteral","object","hypermap","forEach","value","key","isMap","set","Array","isArray","Hyperlist","isCollection","includes","name","hydrate","script","err","console","log","message","rels","fetchTransclusion","children","child","fetch","method","url","URL","href","window","location","assign","headers","body","options","JSON","stringify","response","redirected","callbackfn","at","path","length","head","get","undefined","slice","filter","concat","keyFor","node","has","event","CustomEvent","detail","dispatchEvent","contentChanged","keys","replace","otherHypermap","Error","json","newNode","toJSON","obj","fromEntries","toString"],"mappings":"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"}