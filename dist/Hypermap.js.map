{"version":3,"sources":["../src/Hypermap.js"],"sourcesContent":["import { isMap } from './utils/json_processing.js';\nimport Hyperlist from './Hyperlist.js';\n\nexport default class Hypermap extends EventTarget {\n\tattributes;\n\tmap;\n\t#parent;\n\t#tab;\n\n\tconstructor(data, attributes, parent, tab = null) {\n\t\tsuper();\n\t\tthis.map = new Map(Object.entries(data));\n\t\tthis.attributes = attributes;\n\t\tthis.#parent = parent;\n\t\tthis.#tab = tab;\n\t}\n\n\tstatic fromJSON(object, scripts = [], transcludedNodes = [], parent = null, tab = null) {\n\t\tconst attributes = object['@'] || {};\n\t\tdelete object['@'];\n\n\t\tlet hypermap = new this(object, attributes, parent, tab);\n\t\thypermap.forEach((value, key) => {\n\t\t\tif (isMap(value)) {\n\t\t\t\thypermap.map.set(key, this.fromJSON(value, scripts, transcludedNodes, hypermap, tab));\n\t\t\t} else if (Array.isArray(value)) {\n\t\t\t\thypermap.map.set(key, Hyperlist.fromLiteral(value, hypermap));\n\t\t\t\t// value.map((item, index) => {\n\t\t\t\t// \tif (isMap(item)) {\n\t\t\t\t// \t\tvalue[index] = this.fromJSON(item, scripts, transcludedNodes, hypermap, tab);\n\t\t\t\t// \t}\n\t\t\t\t// });\n\t\t\t}\n\t\t});\n\n\t\t// Push transcluded nodes to a list to load later\n\t\tif (attributes.rels?.includes('transclude')) {\n\t\t\ttranscludedNodes.push(hypermap);\n\t\t}\n\t\t\n\t\t// Push script URLs to a queue to load later\n\t\tif (attributes.script && typeof window !== 'undefined') {\n\t\t\tconst url = new URL(attributes.script, window.location.href);\n\t\t\tscripts.push(url);\n\t\t}\n\t\treturn hypermap;\n\t}\n\n\t// Todo: make isomorphic\n\tasync fetch() {\n\t\tconst method = this.attributes.method || 'get';\n\t\tconst url = new URL(this.attributes.href, window.location);\n\n\t\tif (method === 'get') {\n\t\t\tif (this.attributes.rels?.includes('transclude')) {\n\t\t\t\tawait this.fetchTransclusion();\n\t\t\t} else {\n\t\t\t\twindow.location.assign(url);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tconst headers = {\n\t\t\t'Content-Type': 'application/json'\n\t\t};\n\n\t\tconst body = {};\n\t\tthis.forEach((value, key) => {\n\t\t\tbody[key] = value;\n\t\t});\n\n\t\tconst options = { method, headers, body: JSON.stringify(body) };\n\t\tconst response = await fetch(url, options);\n\n\t\tif (response.redirected) {\n\t\t\twindow.location.assign(response.url);\n\t\t}\n\t}\n\n\tforEach(callbackfn) {\n\t\tthis.map.forEach(callbackfn);\n\t}\n\n\tat(...path) {\n\t\tif (path.length === 0) {\n\t\t\treturn this;\n\t\t}\n\t\t\n\t\tconst head = this.map.get(path.at(0));\n\t\tif (head === undefined || (path.length > 1 && typeof head.at !== 'function')) {\n\t\t\treturn undefined;\n\t\t}\n\t\t\n\t\tif (path.length === 1) {\n\t\t\treturn head;\n\t\t} else {\n\t\t\treturn head.at(...path.slice(1));\n\t\t}\n\t}\n\n\tparent() {\n\t\tthis.parent;\n\t}\n\n\tchildren() {\n\t\treturn [...this.map]\n\t\t\t.filter(([_, value]) => isMap(value) || Array.isArray(value))\n\t\t\t.map(([_, value]) => value);\n\t}\n\t\n\tpath() {\n\t\tif (this.#parent === null) {\n\t\t\treturn [];\n\t\t} else {\n\t\t\treturn this.#parent.path().concat(this.#parent.keyFor(this));\n\t\t}\n\t}\n\n\tkeyFor(node) {\n\t\tfor (const [key, value] of this.map) {\n\t\t\tif (value === node) {\n\t\t\t\treturn key;\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\thas(key) {\n\t\treturn this.map.has(key);\n\t}\n\n\tset(key, value) {\n\t\tthis.map.set(key, value);\n\t\tconst event = new CustomEvent('changed', { detail: { key, value } });\n\t\tthis.dispatchEvent(event);\n\t\twindow.contentChanged();\n\t\treturn this;\n\t}\n\n\tkeys() {\n\t\treturn this.map.keys();\n\t}\n\n\treplace(otherHypermap) {\n\t\tthis.map = otherHypermap.map;\n\t\treturn this;\n\t}\n\n\tlength() {\n\t\tthrow new Error('DRAGONS');\n\t}\n\n\t// Todo: make isomorphic\n\tasync fetchTransclusion() {\n\t\tconst response = await fetch(this.attributes.href);\n\t\tconst json = await response.json();\n\t\t// Todo: should handle scripts and sub-transclusions\n\t\tconst newNode = await Hypermap.fromJSON(json, [], []);\n\t\tthis.replace(newNode);\n\t}\n\n\ttoJSON() {\n\t\tconst obj = Object.fromEntries(this.map);\n\t\tif (Object.entries(this.attributes).length > 0) {\n\t\t\tobj['@'] = this.attributes;\n\t\t}\n\t\treturn obj;\n\t}\n\n\ttoString() {\n\t\treturn JSON.stringify(this, null, 2);\n\t}\n}\n"],"names":["Hypermap","EventTarget","attributes","map","parent","tab","constructor","data","Map","Object","entries","fromJSON","object","scripts","transcludedNodes","hypermap","forEach","value","key","isMap","set","Array","isArray","Hyperlist","fromLiteral","rels","includes","push","script","window","url","URL","location","href","fetch","method","fetchTransclusion","assign","headers","body","options","JSON","stringify","response","redirected","callbackfn","at","path","length","head","get","undefined","slice","children","filter","_","concat","keyFor","node","has","event","CustomEvent","detail","dispatchEvent","contentChanged","keys","replace","otherHypermap","Error","json","newNode","toJSON","obj","fromEntries","toString"],"mappings":"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"}