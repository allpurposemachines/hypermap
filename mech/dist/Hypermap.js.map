{"version":3,"sources":["../src/Hypermap.js"],"sourcesContent":["import { isMap } from './utils/json_processing.js';\nimport Hyperlist from './Hyperlist.js';\n\nexport default class Hypermap extends EventTarget {\n\tattributes;\n\tmap;\n\t#parent;\n\n\tconstructor(data, attributes, parent) {\n\t\tsuper();\n\t\tthis.map = new Map(Object.entries(data));\n\t\tthis.attributes = attributes;\n\t\tthis.#parent = parent;\n\t}\n\n\tstatic fromLiteral(object, parent = null) {\n\t\tconst attributes = object['@'] || {};\n\t\tdelete object['@'];\n\n\t\tlet hypermap = new this(object, attributes, parent);\n\t\thypermap.forEach((value, key) => {\n\t\t\tif (isMap(value)) {\n\t\t\t\thypermap.map.set(key, this.fromLiteral(value, hypermap));\n\t\t\t} else if (Array.isArray(value)) {\n\t\t\t\thypermap.map.set(key, Hyperlist.fromLiteral(value, hypermap));\n\t\t\t}\n\t\t});\n\t\treturn hypermap;\n\t}\n\n\tasync hydrate() {\n\t\tif (this.attributes.script) {\n\t\t\ttry {\n\t\t\t\tawait import(this.attributes.script);\n\t\t\t} catch(err) {\n\t\t\t\tconsole.log(`Error importing script at ${this.attributes.script}`, err.message);\n\t\t\t}\n\t\t}\n\t\n\t\tif (this.attributes.rels?.includes('transclude')) {\n\t\t\tawait this.fetchTransclusion();\n\t\t}\n\n\t\tthis.children().forEach(child => {\n\t\t\tchild.hydrate();\n\t\t})\n\t}\n\n\tasync fetch() {\n\t\tconst method = this.attributes.method || 'get';\n\t\tconst url = new URL(this.attributes.href, window.location);\n\n\t\tif (method === 'get') {\n\t\t\tif (this.attributes.rels?.includes('transclude')) {\n\t\t\t\tawait this.fetchTransclusion();\n\t\t\t} else {\n\t\t\t\twindow.location.assign(url);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tconst headers = {\n\t\t\t'Content-Type': 'application/json'\n\t\t};\n\n\t\tconst body = {};\n\t\tthis.forEach((value, key) => {\n\t\t\tbody[key] = value;\n\t\t});\n\n\t\tconst options = { method, headers, body: JSON.stringify(body) };\n\t\tconst response = await fetch(url, options);\n\n\t\tif (response.redirected) {\n\t\t\twindow.location.assign(response.url);\n\t\t}\n\t}\n\n\tasync $(key, values) {\n\t\tconst node = this.at(key);\n\t\tif (values) {\n\t\t\tObject.entries(values).forEach(([key, value]) => {\n\t\t\t\tnode.set(key, value);\n\t\t\t});\n\t\t}\n\t\tawait node.fetch();\n\t}\n\n\tforEach(callbackfn) {\n\t\tthis.map.forEach(callbackfn);\n\t}\n\n\tat(...path) {\n\t\tif (path.length === 0) {\n\t\t\treturn this;\n\t\t}\n\t\t\n\t\tconst head = this.map.get(path.at(0));\n\t\tif (head === undefined || (path.length > 1 && typeof head.at !== 'function')) {\n\t\t\treturn undefined;\n\t\t}\n\t\t\n\t\tif (path.length === 1) {\n\t\t\treturn head;\n\t\t} else {\n\t\t\treturn head.at(...path.slice(1));\n\t\t}\n\t}\n\n\tparent() {\n\t\treturn this.#parent;\n\t}\n\n\tchildren() {\n\t\treturn [...this.map.values()]\n\t\t\t.filter(value => value.isCollection && value.isCollection());\n\t}\n\t\n\tpath() {\n\t\tif (this.parent() === null) {\n\t\t\treturn [];\n\t\t} else {\n\t\t\treturn this.parent().path().concat(this.parent().keyFor(this));\n\t\t}\n\t}\n\n\tkeyFor(node) {\n\t\tfor (const [key, value] of this.map) {\n\t\t\tif (value === node) {\n\t\t\t\treturn key;\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\thas(key) {\n\t\treturn this.map.has(key);\n\t}\n\n\tset(key, value) {\n\t\tthis.map.set(key, value);\n\t\tif (window) {\n\t\t\tconst event = new CustomEvent('changed', { detail: { key, value } });\n\t\t\tthis.dispatchEvent(event);\n\t\t\twindow.contentChanged();\n\t\t}\n\t\treturn this;\n\t}\n\n\tkeys() {\n\t\treturn this.map.keys();\n\t}\n\n\treplace(otherHypermap) {\n\t\tthis.map = otherHypermap.map;\n\t\treturn this;\n\t}\n\n\tlength() {\n\t\treturn [...this.map.values()].length;\n\t}\n\n\tisCollection() {\n\t\treturn true;\n\t}\n\n\tasync fetchTransclusion() {\n\t\tconst response = await fetch(this.attributes.href);\n\t\tconst json = await response.json();\n\t\t// Todo: should handle scripts and sub-transclusions\n\t\tconst newNode = this.constructor.fromLiteral(json);\n\t\tthis.replace(newNode);\n\t}\n\n\ttoJSON() {\n\t\tconst obj = Object.fromEntries(this.map);\n\t\tif (Object.entries(this.attributes).length > 0) {\n\t\t\tobj['@'] = this.attributes;\n\t\t}\n\t\treturn obj;\n\t}\n\n\ttoString() {\n\t\treturn JSON.stringify(this, null, 2);\n\t}\n}\n"],"names":["Hypermap","EventTarget","attributes","map","parent","constructor","data","Map","Object","entries","fromLiteral","object","hypermap","forEach","value","key","isMap","set","Array","isArray","Hyperlist","hydrate","script","err","console","log","message","rels","includes","fetchTransclusion","children","child","fetch","method","url","URL","href","window","location","assign","headers","body","options","JSON","stringify","response","redirected","$","values","node","at","callbackfn","path","length","head","get","undefined","slice","filter","isCollection","concat","keyFor","has","event","CustomEvent","detail","dispatchEvent","contentChanged","keys","replace","otherHypermap","json","newNode","toJSON","obj","fromEntries","toString"],"mappings":";;;;+BAGA;;aAAqBA;;iCAHC;kEACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEP,MAAMA,iBAAiBC;IACrCC,WAAW;IACXC,IAAI;IACJ,CAACC,MAAM,CAAC;IAERC,YAAYC,IAAI,EAAEJ,UAAU,EAAEE,MAAM,CAAE;QACrC,KAAK;QACL,IAAI,CAACD,GAAG,GAAG,IAAII,IAAIC,OAAOC,OAAO,CAACH;QAClC,IAAI,CAACJ,UAAU,GAAGA;QAClB,IAAI,CAAC,CAACE,MAAM,GAAGA;IAChB;IAEA,OAAOM,YAAYC,MAAM,EAAEP,SAAS,IAAI,EAAE;QACzC,MAAMF,aAAaS,MAAM,CAAC,IAAI,IAAI,CAAC;QACnC,OAAOA,MAAM,CAAC,IAAI;QAElB,IAAIC,WAAW,IAAI,IAAI,CAACD,QAAQT,YAAYE;QAC5CQ,SAASC,OAAO,CAAC,CAACC,OAAOC,MAAQ;YAChC,IAAIC,IAAAA,sBAAK,EAACF,QAAQ;gBACjBF,SAAST,GAAG,CAACc,GAAG,CAACF,KAAK,IAAI,CAACL,WAAW,CAACI,OAAOF;YAC/C,OAAO,IAAIM,MAAMC,OAAO,CAACL,QAAQ;gBAChCF,SAAST,GAAG,CAACc,GAAG,CAACF,KAAKK,kBAAS,CAACV,WAAW,CAACI,OAAOF;YACpD,CAAC;QACF;QACA,OAAOA;IACR;IAEA,MAAMS,UAAU;QACf,IAAI,IAAI,CAACnB,UAAU,CAACoB,MAAM,EAAE;YAC3B,IAAI;gBACH,MAAM,gBAAO,IAAI,CAACpB,UAAU,CAACoB,MAAM,oDAA7B;YACP,EAAE,OAAMC,KAAK;gBACZC,QAAQC,GAAG,CAAC,CAAC,0BAA0B,EAAE,IAAI,CAACvB,UAAU,CAACoB,MAAM,CAAC,CAAC,EAAEC,IAAIG,OAAO;YAC/E;QACD,CAAC;QAED,IAAI,IAAI,CAACxB,UAAU,CAACyB,IAAI,EAAEC,SAAS,eAAe;YACjD,MAAM,IAAI,CAACC,iBAAiB;QAC7B,CAAC;QAED,IAAI,CAACC,QAAQ,GAAGjB,OAAO,CAACkB,CAAAA,QAAS;YAChCA,MAAMV,OAAO;QACd;IACD;IAEA,MAAMW,QAAQ;QACb,MAAMC,SAAS,IAAI,CAAC/B,UAAU,CAAC+B,MAAM,IAAI;QACzC,MAAMC,MAAM,IAAIC,IAAI,IAAI,CAACjC,UAAU,CAACkC,IAAI,EAAEC,OAAOC,QAAQ;QAEzD,IAAIL,WAAW,OAAO;YACrB,IAAI,IAAI,CAAC/B,UAAU,CAACyB,IAAI,EAAEC,SAAS,eAAe;gBACjD,MAAM,IAAI,CAACC,iBAAiB;YAC7B,OAAO;gBACNQ,OAAOC,QAAQ,CAACC,MAAM,CAACL;YACxB,CAAC;YACD;QACD,CAAC;QAED,MAAMM,UAAU;YACf,gBAAgB;QACjB;QAEA,MAAMC,OAAO,CAAC;QACd,IAAI,CAAC5B,OAAO,CAAC,CAACC,OAAOC,MAAQ;YAC5B0B,IAAI,CAAC1B,IAAI,GAAGD;QACb;QAEA,MAAM4B,UAAU;YAAET;YAAQO;YAASC,MAAME,KAAKC,SAAS,CAACH;QAAM;QAC9D,MAAMI,WAAW,MAAMb,MAAME,KAAKQ;QAElC,IAAIG,SAASC,UAAU,EAAE;YACxBT,OAAOC,QAAQ,CAACC,MAAM,CAACM,SAASX,GAAG;QACpC,CAAC;IACF;IAEA,MAAMa,EAAEhC,GAAG,EAAEiC,MAAM,EAAE;QACpB,MAAMC,OAAO,IAAI,CAACC,EAAE,CAACnC;QACrB,IAAIiC,QAAQ;YACXxC,OAAOC,OAAO,CAACuC,QAAQnC,OAAO,CAAC,CAAC,CAACE,KAAKD,MAAM,GAAK;gBAChDmC,KAAKhC,GAAG,CAACF,KAAKD;YACf;QACD,CAAC;QACD,MAAMmC,KAAKjB,KAAK;IACjB;IAEAnB,QAAQsC,UAAU,EAAE;QACnB,IAAI,CAAChD,GAAG,CAACU,OAAO,CAACsC;IAClB;IAEAD,GAAG,GAAGE,IAAI,EAAE;QACX,IAAIA,KAAKC,MAAM,KAAK,GAAG;YACtB,OAAO,IAAI;QACZ,CAAC;QAED,MAAMC,OAAO,IAAI,CAACnD,GAAG,CAACoD,GAAG,CAACH,KAAKF,EAAE,CAAC;QAClC,IAAII,SAASE,aAAcJ,KAAKC,MAAM,GAAG,KAAK,OAAOC,KAAKJ,EAAE,KAAK,YAAa;YAC7E,OAAOM;QACR,CAAC;QAED,IAAIJ,KAAKC,MAAM,KAAK,GAAG;YACtB,OAAOC;QACR,OAAO;YACN,OAAOA,KAAKJ,EAAE,IAAIE,KAAKK,KAAK,CAAC;QAC9B,CAAC;IACF;IAEArD,SAAS;QACR,OAAO,IAAI,CAAC,CAACA,MAAM;IACpB;IAEA0B,WAAW;QACV,OAAO;eAAI,IAAI,CAAC3B,GAAG,CAAC6C,MAAM;SAAG,CAC3BU,MAAM,CAAC5C,CAAAA,QAASA,MAAM6C,YAAY,IAAI7C,MAAM6C,YAAY;IAC3D;IAEAP,OAAO;QACN,IAAI,IAAI,CAAChD,MAAM,OAAO,IAAI,EAAE;YAC3B,OAAO,EAAE;QACV,OAAO;YACN,OAAO,IAAI,CAACA,MAAM,GAAGgD,IAAI,GAAGQ,MAAM,CAAC,IAAI,CAACxD,MAAM,GAAGyD,MAAM,CAAC,IAAI;QAC7D,CAAC;IACF;IAEAA,OAAOZ,IAAI,EAAE;QACZ,KAAK,MAAM,CAAClC,KAAKD,MAAM,IAAI,IAAI,CAACX,GAAG,CAAE;YACpC,IAAIW,UAAUmC,MAAM;gBACnB,OAAOlC;YACR,CAAC;QACF;QAEA,OAAOyC;IACR;IAEAM,IAAI/C,GAAG,EAAE;QACR,OAAO,IAAI,CAACZ,GAAG,CAAC2D,GAAG,CAAC/C;IACrB;IAEAE,IAAIF,GAAG,EAAED,KAAK,EAAE;QACf,IAAI,CAACX,GAAG,CAACc,GAAG,CAACF,KAAKD;QAClB,IAAIuB,QAAQ;YACX,MAAM0B,QAAQ,IAAIC,YAAY,WAAW;gBAAEC,QAAQ;oBAAElD;oBAAKD;gBAAM;YAAE;YAClE,IAAI,CAACoD,aAAa,CAACH;YACnB1B,OAAO8B,cAAc;QACtB,CAAC;QACD,OAAO,IAAI;IACZ;IAEAC,OAAO;QACN,OAAO,IAAI,CAACjE,GAAG,CAACiE,IAAI;IACrB;IAEAC,QAAQC,aAAa,EAAE;QACtB,IAAI,CAACnE,GAAG,GAAGmE,cAAcnE,GAAG;QAC5B,OAAO,IAAI;IACZ;IAEAkD,SAAS;QACR,OAAO;eAAI,IAAI,CAAClD,GAAG,CAAC6C,MAAM;SAAG,CAACK,MAAM;IACrC;IAEAM,eAAe;QACd,OAAO,IAAI;IACZ;IAEA,MAAM9B,oBAAoB;QACzB,MAAMgB,WAAW,MAAMb,MAAM,IAAI,CAAC9B,UAAU,CAACkC,IAAI;QACjD,MAAMmC,OAAO,MAAM1B,SAAS0B,IAAI;QAChC,oDAAoD;QACpD,MAAMC,UAAU,IAAI,CAACnE,WAAW,CAACK,WAAW,CAAC6D;QAC7C,IAAI,CAACF,OAAO,CAACG;IACd;IAEAC,SAAS;QACR,MAAMC,MAAMlE,OAAOmE,WAAW,CAAC,IAAI,CAACxE,GAAG;QACvC,IAAIK,OAAOC,OAAO,CAAC,IAAI,CAACP,UAAU,EAAEmD,MAAM,GAAG,GAAG;YAC/CqB,GAAG,CAAC,IAAI,GAAG,IAAI,CAACxE,UAAU;QAC3B,CAAC;QACD,OAAOwE;IACR;IAEAE,WAAW;QACV,OAAOjC,KAAKC,SAAS,CAAC,IAAI,EAAE,IAAI,EAAE;IACnC;AACD"}